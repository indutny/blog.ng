<!DOCTYPE html>
<html>
  <head>
    <meta name=viewport content"width=device-width,initial-scale=1,maximum-scale=10" />
    
    <title>Bitcoin to the Moon</title>
    
    <link rel=alternate type="application/rss+xml" href="http://darksi.de/rss.xml" title="Fedor Indutny's blog">
    <link rel=stylesheet href="/css/main.css" />
  </head>
  <body>
    <aside id=info>
      <section class=info-title>
        <a href="/">darksi.de</a>
        <br/>
        of
        </br>
        Software Engineering
      </section>
    
      <section class=info-copyright>
        Copyright <a href="https://github.com/indutny">Fedor Indutny</a>,
        view <a href="http://opensource.org/licenses/mit-license.php">license</a>
      </section>
    
      <section class=info-credits>
        <i>Icons by: Bluetip Design from the Noun Project</i>
      </section>
    </aside>
    <section id=content>
      <article class=post>
        <section class=post-header>
          <button class=votewdgt title=upvote>?</button>
          <h1>Bitcoin to the Moon</h1>
          <span class=post-header-date>Wed Apr 05 2017 20:00:00 GMT-0400 (Eastern Daylight Time)</span>
        </section>

        <section class=post-body>
          <p>Behold, this is rather unusual post for this blog. Instead of exploring
vastness of technical wonders, this post will concentrate on discussion and
explanation of recent events in Bitcoin community.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li><a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-April/013996.html">Greg Maxwell&#39;s email</a></li>
<li><a href="https://github.com/tothemoon-org/extension-blocks">To the Moon proposal</a></li>
</ul>
<h2 id="statement">Statement</h2>
<p>Recently I got involved in the <a href="https://github.com/tothemoon-org/extension-blocks">initiative</a> related to my past interest in
Bitcoin technology. This effort is lead by <a href="https://github.com/chjj">Christopher Jeffrey (JJ)</a> from
<a href="https://purse.io/">purse.io</a>, <a href="https://twitter.com/jcp?lang=en">Joseph Poon</a> from <a href="http://lightning.network/">Lightning Network</a>, <a href="https://twitter.com/spair">Stephen Pair</a>
from <a href="https://bitpay.com/">bitpay.com</a>. To make it clear from the start, my contribution to this
project was rather small and limited to providing superficial technical review.</p>
<p>The <a href="https://github.com/tothemoon-org/extension-blocks">initiative</a> is based off the <a href="https://bitcointalk.org/index.php?topic=283746.0">Auxillary Block proposal</a> that is
slightly older than the <a href="https://github.com/bcoin-org/bcoin">bcoin</a> project. It was modified to
accommodate the use of Lightning, and (although, it is incompatible with
<a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP 141</a>) Segregated Witness (<em>SEGWIT</em>).</p>
<p>The main advantage over Segregated witness is that the block size is no longer
tied to the number of transactions in it. Many transactions could be stored
outside of the canonical blocks in so called Extension blocks. There are pros
and cons to this approach that better be discussed on <a href="https://github.com/tothemoon-org/extension-blocks">github</a>.</p>
<p>The most important thing is that it attempts to solve the contention between
miners and bitcoin core. It has been known for some time that many miners were
willing to switch to <a href="https://www.bitcoinunlimited.info/">Bitcoin Unlimited</a> (_BU_) (or in other words do a
hard-fork) because of the block size limitation. Not only _BU_ is a hard fork,
but it also prone to <a href="http://www.coindesk.com/code-bug-exploit-bitcoin-unlimited-nodes/">bugs</a> that already brought it down once. Obviously,
given this information one has to be very careful when considering it.
<a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">SEGWIT</a>, on other hand, is a fantastic effort and a soft-fork alternative to
_BU_. However it still caps the block size, and thus is not acceptable for
miners for the very same reason as the current version of Bitcoin.</p>
<p>Given this context, <a href="https://github.com/tothemoon-org/extension-blocks">a proposal</a> has been created to address this once and
for all. Purse.io has <a href="https://medium.com/purse-essays/extension-block-story-619a46b58c24">reached out</a> to the companies involved in Bitcoin to
collect their feedback and feature requests. All in all, it appears to me that
&quot;To the Moon&quot; proposal should address the needs of everyone without much
compromise of our ideals and Bitcoin ideology.</p>
<h2 id="asicboost">ASICBOOST</h2>
<p>Almost at the same time as &quot;To the Moon&quot; proposal was published, Greg Maxwell
has sent an <a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-April/013996.html">email</a> about <a href="https://www.asicboost.com/">ASICBOOST</a> and his findings about usage of
this optimization in &quot;particular mining chip&quot; (quoting Greg).</p>
<p>Given the timing this email has sprawled the discussion of miner&#39;s reasons to
&quot;love&quot; <a href="https://github.com/tothemoon-org/extension-blocks">&quot;To the Moon&quot;</a> and &quot;hate&quot; <a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP 141</a>. It turned out that
&quot;To the Moon&quot; was compatible with ASICBOOST&#39;s optimization, while <em>SEGWIT</em> is
not.</p>
<p>I can&#39;t resist diving into the technical details of this optimization, but
before I&#39;ll walk this road with you let me quickly reassure you. As of
<a href="https://github.com/tothemoon-org/extension-blocks/commit/5331eeed1880ecc43a250313415e0d0b02c56bab">this commit</a> &quot;To the Moon&quot; is no longer compatible with ASICBOOST, and,
although it is an open question whether this kind of optimization is
permissible or not, this proposal is on the same grounds with <em>SEGWIT</em> now.</p>
<p><strong>This means that reasons for conspiracy about relationship between
&quot;To the Moon&quot; and miners no longer holds.</strong></p>
<p>If you have any additional prevention measures in mind - please do not hesitate
to open an issue on <a href="https://github.com/tothemoon-org/extension-blocks">github</a>.</p>
<h2 id="technical-details-">Technical details!</h2>
<p>Finally :)</p>
<p>The most of the content below relies on some understanding of
<a href="https://arxiv.org/pdf/1604.00575.pdf">this ASICBOOST paper</a>. This paper is not to hard to follow, so please take
a look.</p>
<p>It is a normal practice in Bitcoin mining to pre-compute as much as possible to
make mining possible. ASIC&#39;s mostly do double SHA256 hashes, thus this
pre-computation relies heavily on splitting SHA256 into phases and sharing data
for inputs that do not change.</p>
<p>The way Bitcoin is mined is by brute-forcing the 32-bit nonce in the block
header until the hash of the header will match current complexity of the
Blockchain (read, number of leading zeroes in the hash). Trying all 32 bits is
of course not enough to generate such fancy looking block hashes, and almost in
every case some additional modifications to the block header are needed.</p>
<p>Given the structure of the block header:</p>
<pre><code>02000000 ........................... Block version: 2

b6ff0b1b1680a2862a30ca44d346d9e8
910d334beb48ca0c0000000000000000 ... Hash of previous block&#39;s header
9d10aa52ee949386ca9385695f04ede2
70dda20810decd12bc9b048aaab31471 ... Merkle root

24d95a54 ........................... Unix time: 1415239972
30c31b18 ........................... Target: 0x1bc330 * 256**(0x18-3)
fe9f0864 ........................... Nonce
</code></pre><p>(<a href="https://bitcoin.org/en/developer-reference#block-headers">Source of the data</a>)</p>
<p>The only field that miners has control of (other than timestamp, which can&#39;t
be changed too much for obvious reasons) is root of the <a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree</a> with
block&#39;s transactions (_TX_) as leafs. This is usually approached by modifying
the first _TX_ (coinbase) in the block.</p>
<p>Now as the Merkle root changes - it will practically invalidate any SHA256
pre-computation that could have been made, since the changes will span both of
the two 64-byte chunks (including padding) forming the 80-byte block header.
(SHA256 operates on 64-byte chunks).</p>
<p>What can one do about it? Second 64-byte chunk starts from the last 4 bytes of
the merkle root... Does it ring the bell yet?</p>
<p>The answer is: collisions!</p>
<p>The pre-computation is still partially possible if the second 64-byte chunk is
the same during mining. One doesn&#39;t have to keep it always the same, generating
few of such colliding chunks is enough to get the benefits of the optimization.</p>
<p>Now how this collision may be generated? The answer is <a href="https://en.wikipedia.org/wiki/Brute-force_attack">brute-force</a>.</p>
<p>(The rest of the post is basically elaboration upon <a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2017-April/013996.html">Greg&#39;s email</a> which I
hope you already checked).</p>
<p>How many brute-force attempts has to be done? Applying <a href="https://en.wikipedia.org/wiki/Birthday_problem">Birthday Paradox</a>
gives the number of tries around <code>2^16</code> (size of whole problem space is <code>2^32</code>,
since we need to collide just 4 bytes) for two colliding block headers. Four of
them will take approximately <code>2^24</code> tries. Quite a lot, but not too much if you
can optimize it. Let&#39;s now consider how this brute-force could work.</p>
<p>The most straightforward way of doing it would be changing the coinbase, but
this is rather expensive for regular blocks. If block has around <code>1500</code> TXs this
means re-computing the Merkle tree branch of length <code>10</code>. Thus <code>10</code>
double-SHA256 per brute-force attempt. Very inefficient!</p>
<p>Can we do less? Yes - we can!</p>
<p>Transactions can be re-arranged in the block to change the Merkle root, each
different permutation will yield a different hash and thus will count as a try.
Permuting 7 branches to the right of the Merkle root yields <code>5040</code> combinations
with <code>7</code> double-SHA526 hashes per try. Changing the coinbase to the left of the
root can produce <code>4096</code> more combinations. Combining these two together gives
us just <code>2^24</code> tries that we was looking for! Now since we pre-cached various
choices for both left and right branches the only thing that is left is compute
double-SHA256 of both of them for every combination. To conclude: just <code>1</code>
double-SHA256 per try! Now this sounds quite good.</p>
<h2 id="segwit-and-to-the-moon">SEGWIT and &quot;To the Moon&quot;</h2>
<p>This optimization is possible with &quot;classical&quot; Bitcoin, but is not feasible with
SEGWIT for a very simple reason. Coinbase in SEGWIT includes the Merkle root
over the rest of transactions (ignoring technical details), which means that
it is not possible to combine left and right branches without changing the
coinbase which brings us back to <code>10</code> double-SHA256 per try.</p>
<p>Initial version of &quot;To the Moon&quot; has a Merkle tree in coinbase too, but it
had to be computed only over transactions that are not present in
classical/canonical block. Meaning that it is easier to do ASICBOOST
optimization on &quot;To the Moon&quot; than on SEGWIT.</p>
<p>Given this description, it is easy to see that <a href="https://github.com/tothemoon-org/extension-blocks/commit/5331eeed1880ecc43a250313415e0d0b02c56bab">the recent change</a> in
&quot;To the Moon&quot; spec makes it non-susceptible to ASICBOOST optimization.</p>
<p>I hope this answers all or at least some of your questions about it.</p>
<p>Thank you for reading!</p>
<h3 id="credits">Credits</h3>
<p>I&#39;d like to thank:</p>
<ul>
<li>Greg Maxwell for doing a quick review of the change to &quot;To the Moon&quot; proposal,
and for helping me understand the details of his discovery</li>
<li>Christopher Jeffrey (JJ) for inviting me to the initiative</li>
<li>Guillermo Rauch for reviewing/proof-reading this post.</li>
</ul>

        </section>
      </article>
    </section>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-68572164-1', 'auto');
      ga('send', 'pageview');
    
    </script>
    <script src="https://vote.wdgt.io/cdn/snippet-v2.js" async></script>
  </body>
</html>
